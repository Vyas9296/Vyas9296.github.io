window.$ = $;
window.jQuery = $;

window.AWZ_APP_ID = "58a420ab10df3d7254a197fe";
window.AWZ_REST_API_KEY = "36babde0-f91b-11e6-8435-29123910477b";

//when any of the specified forms are saved then do an indicative pricing lookup
$(document).on('knack-record-update.view_255 knack-record-update.view_179 knack-record-update.view_182 knack-record-update.view_183 knack-record-update.view_62 knack-record-update.view_31 knack-record-update.view_20', function(event, page, record) {
  //PRICING LOOKUP
  //get the required values from the record
  var calcCreditScore = record.field_557;
  var calcSecurityScore = record.field_558;
  var InvUnd = record.field_553;
  var repaymentStructure = record.field_229;
  var loanTerm = record.field_539;
  
  //create the filter to filter the data with
  var filters = [];
  var creditScoreFilter = dao.createFilter("field_532", "is", calcCreditScore);
  var securityScoreFilter = dao.createFilter("field_533", "is", calcSecurityScore);
  var InvUndFilter = dao.createFilter("field_552", "is", InvUnd);
  var repaymentStructureFilter = dao.createFilter("field_535", "is", repaymentStructure);
  var loanTermFilter = dao.createFilter("field_536", "is", loanTerm);
  
  filters.push(creditScoreFilter);
  filters.push(securityScoreFilter);
  filters.push(InvUndFilter);
  filters.push(repaymentStructureFilter);
  filters.push(loanTermFilter);
  
  //retrieve the data from the Price Lookup object 
  dao.getRecords("object_12", filters).then(function (knackResult){
    if(knackResult.records.length === 0){
      alert ("Pricing Lookup found 0 matching records, Indicative Price cannot be determined.");
    }else if(knackResult.records.length === 1){
      //get the price lookup record & indicative price
      var pricingLookupRecord = knackResult.records[0];
      var indicativePrice = pricingLookupRecord.field_537;
      var indBorrowerPrice = pricingLookupRecord.field_555;
      var baseLenderPrice = pricingLookupRecord.field_559;
      var platformFees = pricingLookupRecord.field_560;
      var termInterest = pricingLookupRecord.field_562;
      var repaymentTypeInterest = pricingLookupRecord.field_564;
      var underwriteFee = pricingLookupRecord.field_565;
      var riskofLoss = pricingLookupRecord.field_566;
      
      //update indicative pricing for the Grading
      var updater = {};
      updater.field_538 = indicativePrice;
      updater.field_554 = indBorrowerPrice;
      updater.field_567 = baseLenderPrice;
      updater.field_568 = platformFees;
      updater.field_572 = termInterest;
      updater.field_569 = repaymentTypeInterest;
      updater.field_570 = underwriteFee;
      updater.field_571 = riskofLoss;
      
      dao.updateRecord("object_1", record.id, updater).then(function(result){
        console.log("updated!");
        utils.gotoParent();
      }, function(err){
       	alert("Error during processing:" + err); 
      });
      
    }else if(knackResult.records.length > 1){
      alert ("Pricing Lookup found: " + knackResult.records.length + " matching records, Indicative Price cannot be determined, too many values.");
    }
  });
  //GRADING LOOKUP
  //get the required values from the record
  var fssScoreBand = record.field_154;
  var delphiScoreBand = record.field_155;
  var salesgrowthBand = record.field_236;
  var emptgrowthBand = record.field_237;
  var turbulentBand =  record.field_141;
  //create the filter to filter the data with
  var filters = [];
  var fssScoreBandFilter = dao.createFilter("field_578", "is", fssScoreBand);
  var delphiScoreBandFilter = dao.createFilter("field_577", "is", delphiScoreBand);
  var salesgrowthBandFilter = dao.createFilter("field_588", "is", salesgrowthBand);
  var emptgrowthBandFilter = dao.createFilter("field_589", "is", emptgrowthBand);
  var turbulentBandFilter =  dao.createFilter("field_590", "is", turbulentBand);
  
  filters.push(fssScoreBandFilter);
  filters.push(delphiScoreBandFilter);
  filters.push(salesgrowthBandFilter);
  filters.push(emptgrowthBandFilter);
  filters.push(turbulentBandFilter);
  
  //retrieve the data from the Grading Lookup object 
  dao.getRecords("object_13", filters).then(function (knackResult){
    if(knackResult.records.length === 0){
      alert ("Record Saved. Error Code 1: Grading cannot be determined.");
    }else if(knackResult.records.length === 1){
      //get the grade lookup record & indicative price
      var gradingLookupRecord = knackResult.records[0];
      var fssBand = gradingLookupRecord.field_580;
      var delphiBand = gradingLookupRecord.field_579;
      var hfs = gradingLookupRecord.field_591;
      var stgp = gradingLookupRecord.field_592;
      var turbulence = gradingLookupRecord.field_593;
      var dynamicscore = gradingLookupRecord.field_594;
      var creditscore = gradingLookupRecord.field_595;
      

      
      //update indicative pricing for the Grading
      var updater = {};
      updater.field_582 = fssBand;
      updater.field_581 = delphiBand;
      updater.field_583 = hfs;
      updater.field_584 = stgp;
      updater.field_585 = turbulence;
      updater.field_586 = dynamicscore;
      updater.field_587 = creditscore;
      
      dao.updateRecord("object_1", record.id, updater).then(function(result){
        console.log("updated!");
        
      }, function(err){
       	alert("Error during processing:" + err); 
      });
      
    }else if(knackResult.records.length > 1){
      alert ("Record Saved. Grading Lookup found: " + knackResult.records.length + " matching records, Grading cannot be determined, too many values.");
    }
  });
});

//dao
function daoUtil(){}function createRecordPromise(e,r,t){var o=getKnackUrl(e,"records");return ajax(o,"POST",r,null,t)}function getRecordPromise(e,r){var t=getKnackUrl(e,KNACK_TYPE_RECORDS)+"/"+r;return ajax(t,"GET")}function getRecordsPromise(e,r,t,o,n,a){var i=null;void 0===r||null===r?r="":(r.constructor!==Array&&(r=[r]),r=JSON.stringify(r),i={},i.filters=r);var c=getKnackUrl(e,KNACK_TYPE_RECORDS);if(t){var u=o||"asc";c+="?sort_field="+t+"&sort_order="+u}return ajax(c,"GET",i,n,null,a)}function updateRecordPromise(e,r,t){var o=getKnackUrl(e,KNACK_TYPE_RECORDS)+"/"+r;return ajax(o,"PUT",t)}function ajax(e,r,t,o,n,a){return"POST"!==r&&"PUT"!==r&&(t||o||a)&&(e=addQuestionMarkIfNotPresent(e)),o&&(e=e+"&rows_per_page="+o),a&&(e=e+"&page="+a),jqueryQuery(e,r,t,n)}function addQuestionMarkIfNotPresent(e){return-1===e.indexOf("?")&&(e+="?"),e}function jqueryQuery(e,r,t,o){var n=window.AWZ_APP_ID,a=window.AWZ_REST_API_KEY;return $.ajax({url:e,type:r,headers:{"X-Knack-Application-Id":n,"X-Knack-REST-API-Key":a},data:t,success:function(e){console.log("success!")},error:function(e,r){console.log("failed!"+r),console.log("failed!"+e.responseText),o&&o(r)}})}function getKnackUrl(e,r){return knackApiUrl+"objects/"+e+"/"+r}function createFilter(e,r,t){return daoUtil.createFilter(e,r,t)}function getReportPromise(e,r){var t=knackApiUrl+"scenes/"+e+"/views/"+r+"/report";return ajax(t,"GET")}function getViewRegordsKnackUrl(e,r){return knackApiUrl+"pages/"+e+"/views/"+r+"/records"}var knackApiUrl="https://api.knack.com/v1/",KNACK_TYPE_RECORDS="records",OPERATOR_IS="is",valueToIdMapCache={},MAX_CACHE_TTL=10;daoUtil.OPERATOR_IS="is",daoUtil.prototype.createRecord=function(e,r,t){return createRecordPromise(e,r,t)},daoUtil.prototype.getRecord=function(e,r){return getRecordPromise(e,r)},daoUtil.prototype.getRecords=function(e,r,t,o,n,a){return getRecordsPromise(e,r,t,o,n,a)},daoUtil.prototype.getChildren=function(e,r,t,o){var n=[createFilter(t,OPERATOR_IS,[r])];return daoUtil.getRecords(e,n,o)},daoUtil.prototype.updateRecord=function(e,r,t){return updateRecordPromise(e,r,t)},daoUtil.prototype.deleteRecord=function(e,r){var t=getKnackUrl(e,KNACK_TYPE_RECORDS)+"/"+r;return ajax(t,"DELETE")},daoUtil.prototype.createFilter=function(e,r,t){return{field:e,operator:r,value:t}},daoUtil.prototype.getValueToIdMap=function(e,r){return getValueToIdMap(e,r)},daoUtil.prototype.getReport=function(e,r){return getReportPromise(e,r)},daoUtil.prototype.getFieldNamesForObject=function(e){var r=getKnackUrl(e,"fields");return ajax(r,"GET")},daoUtil.prototype.getKnackValue=function(e,r){if(!r)throw new Error("no field!");var t=null,o=r;-1===r.indexOf("_raw")&&(o=r+"_raw");var n=e.hasOwnProperty(o)&&"object"==typeof e[o];return t=n&&""!==e[r]?e[o]instanceof Array&&e[o].length>0?e[o][0].id:e[o]:e[r]},daoUtil.prototype.getViewRecords=function(e,r){var t=getViewRegordsKnackUrl(e,r);return ajax(t,"GET")},console.log("running browser"),window.dao=new daoUtil;var dao=new daoUtil;

$(document).on('knack-view-render.any', function(event, view, record) {
  $('.kn-add-filter').text('Advanced Search')
});


//utils
function createListView(t,e){void 0===e&&(e="mediumTable");var n='<table class="'+e+'" style="">';n+="<tbody>";for(var o=0;o<t.length;o++)n+="<tr>",n+='<td style="">'+t[o].label+"</td>",n+='<td style="">'+t[o].value+"</td>",n+="</tr>";return n+="</tbody>",n+="</table>"}function ListData(t,e){this.label=t,this.value=e}function addTextDiv(t,e){t.append($("<div>"+e+"</div>"))}function getAllValues(t){var e=[];for(var n in t)e.push(t[n]);return e}function createLiteral(t,e){var n={};return n[t]=e,n}function gotoKnackParent(t){t||(t=""),window.location.href=getParentUrl(window.location.href.toString())+t}function getParentUrl(t){var e=t.lastIndexOf("/");return e=t.lastIndexOf("/",e-2),e=t.lastIndexOf("/",e-2),t.substring(0,e)}function getURLParameter(t){var e=new RegExp(t+"=([^&]*)","i").exec(window.location.search);return e&&unescape(e[1])||""}function broadcast(t,e,n){radio(t).broadcast(e,n)}function Utils(){}Utils.prototype.createTableView=function(t,e,n){void 0===e&&(e="mediumTable"),void 0===n&&(n=!0);var o="object"!=typeof t?JSON.parse(t):t,i='<table class="'+e+'" style="border: 1px solid black;border-collapse:collapse;">';if(n){i+="<thead><tr>";for(var r in o[0])i+='<th scope="col">'+r+"</th>";i+="</tr></thead>"}i+="<tbody>";for(var a=0;a<o.length;a++){i+=a%2===0?'<tr class="alt">':"<tr>";for(var l in o[a])i+='<td style="border: 1px solid black;">'+o[a][l]+"</td>";i+="</tr>"}return i+="</tbody>",i+="</table>"},Utils.prototype.init=function(){console.info("Utils initialized"),window.awzKnackInit&&window.awzKnackInit()},Utils.prototype.showField=function(t){$("#kn-input-"+t).show()},Utils.prototype.hideField=function(t){},Utils.prototype.getFieldValue=function(t){var e="",n=$("#"+t);return 0===n.length?(n=$("input[name='"+t+"']:checked"),0===n.length?(n=$("input[name='"+t+"']"),0===n.length||(e=n.val())):e=n.val()):e=n.val(),e},Utils.prototype.setFieldValue=function(t,e,n){"undefined"==typeof n&&(n=!0);var o=$("#"+t);if(0===o.length){var i=":checkbox[name='"+t+"']";if(e&&(i+="[value='"+e+"']"),o=$(i),0===o.length){var r=":radio[name='"+t+"'][value='"+e+"']";o=$(r),0===o.length&&console.log("Can't find field to set for selector: "+r)}o.is(":checkbox")||o.is(":radio")?0===o.length?console.log("Can't find checkbox to set for fieldName: "+t):(o.attr("checked",n),o[0].click()):o.val(e)}else o.val(e);return!0},Utils.prototype.disableInputField=function(t){return $("#"+t).prop("disabled",!0)},Utils.prototype.enableInputField=function(t){return $("#"+t).prop("disabled",!1)},Utils.prototype.disableDropdown=function(t){$("#kn-input-"+t).css("pointer-events","none");var e=$("#kn-input-"+t+" div:first a");e.data("customDisabled",e.css("background-image")),e.css("background-image","none"),e.css("background-color","lightGray")},Utils.prototype.enableDropdown=function(t){var e=$("#kn-input-"+t+" div:first a");e.data("customDisabled")&&(e.css("background-image",e.data("customDisabled")),e.removeData("customDisabled"),e.css("background-color","")),$("#kn-input-"+t).css("pointer-events","")},Utils.prototype.disableMultiChoice=function(t){$("#kn-input-"+t).css("pointer-events","none")},Utils.prototype.enableMultiChoice=function(t){$("#kn-input-"+t).css("pointer-events","")},Utils.prototype.disableField=function(t){var e=$("#kn-input-"+t);e.hasClass("kn-input-connection")?this.disableDropdown(t):e.hasClass("kn-input-short_text")?this.disableInputField(t):e.hasClass("kn-input-multiple_choice")?this.disableMultiChoice(t):console.warn("Unable to disable field with name:"+t)},Utils.prototype.enableField=function(t){var e=$("#kn-input-"+t);e.hasClass("kn-input-connection")?this.enableDropdown(t):e.hasClass("kn-input-short_text")?this.enableInputField(t):e.hasClass("kn-input-multiple_choice")?this.enableMultiChoice(t):console.warn("Unable to enable field with name:"+t)},Utils.prototype.hash=function(t){var e="";if(0===t.length)return e;for(var n=0;n<t.length;n++){var o=t.charCodeAt(n);e=(e<<5)-e+o,e&=e}return e},Utils.prototype.getComboboxSelector=function(t){return'select[name="'+t+'"]'},Utils.prototype.getSelectedComboboxValue=function(t){return $(this.getComboboxSelector(t)).find(":selected").text()},Utils.prototype.getSelectedComboboxIdValue=function(t){return $(this.getComboboxSelector(t)).find(":selected").val()},Utils.prototype.setSelectedComboboxValue=function(t,e,n,o,i){i||(i=!0);var r=$("#view_"+t+"_field_"+e+"_chzn a span");r.text(n);var a=$("select#view_"+t+"-field_"+e);if(o?a.val(o):a.find("option").filter(function(){return $(this).text()==n}).prop("selected",!0),n){var l=$('li:contains("'+n+'")');l.click()}i&&(a.trigger("change"),a.trigger("liszt:updated"))},Utils.prototype.setSearchCombobox=function(t,e,n,o,i){var r="select[name='"+e+"']",a=$(r);if(i){var l=a.find("option:nth-child("+(i+1)+")").val();a.val(l)}else a.val(o);var s=$('li:contains("'+n+'")');s.click(),a.trigger("change")},Utils.prototype.setSelectedCombobox=function(t,e){var n=null;n="string"==typeof t?$(t):t,n.val(e),n.trigger("liszt:updated"),n.trigger("chosen:updated")},Utils.prototype.normalizeAddressString=function(t){return this.replaceAll(t,"<br />","\n")},Utils.prototype.replaceAll=function(t,e,n){var o=new RegExp(e,"g");return t=t.replace(o,n)},Utils.prototype.bindOnChangListener=function(t,e){var n=this;$(n.getComboboxSelector(t)).change(e)},Utils.prototype.setComboboxOnChangeListener=function(t,e){var n=this;$(n.getComboboxSelector(t)).change(e)},Utils.prototype.bindManyOnChangListener=function(){for(var t=this,e=arguments[0],n=1;n<arguments.length;n++){var o=arguments[n];t.bindOnChangListener(o,e)}},Utils.prototype.setRadioButtonChecked=function(t,e,n,o){var i=$("input[type=radio][name="+t+"-"+e+"][value='"+n+"'");return o&&$("input[type=radio][name="+t+"-"+e+"]:checked").val()?(console.info("Skip select radio button."),!1):(i.prop("checked",!0),i.change(),!0)},Utils.prototype.setCheckboxButtonChecked=function(t,e,n){$("#"+t+" #kn-input-"+e+" div.conn_inputs  input[type=checkbox][name="+e+"][value='"+n+"'").prop("checked",!0)},Utils.prototype.setRadioButtonChangeListener=function(t,e,n){$("input[type=radio][name="+t+"-"+e+"]").change(n)},Utils.prototype.gotoPage=function(t,e){window.location.href=window.location.href+t+"/"+e},Utils.prototype.gotoNewPage=function(t,e){e||(e=""),window.location.href=window.location.origin+window.location.pathname+t+"/"+e},Utils.prototype.gotoChildPage=function(t,e){e=e||"",window.location.href=window.location.href+t+"/"+e},Utils.prototype.createArray=function(t,e,n){return Array.apply(null,Array(t)).map(function(){var t="";return n&&(t+=n++),e+t})},Utils.prototype.createTextAnimation=function(t,e){var n=0;return setInterval(function(){n=++n%10,$(t).html(e+""+Array(n+1).join("."))},100)},Utils.prototype.formatDate=function(t,e){var n=t.getDate(),o=t.getMonth();o++,10>o&&(o="0"+o);var i=t.getFullYear(),r="";if(e){var a=t.getHours(),l=t.getMinutes(),s=a>=12?"pm":"am";a%=12,a=a?a:12,l=10>l?"0"+l:l,r=a+":"+l+s}return o+"/"+n+"/"+i+" "+r},Utils.prototype.getKnackDate=function(t){var e=t.getDate(),n=t.getMonth();n++,10>n&&(n="0"+n);var o=t.getFullYear(),i=t.getHours(),r=t.getMinutes(),a=i>=12?"pm":"am";i%=12,i=i?i:12,r=10>r?"0"+r:r;var l={};return l.date=n+"/"+e+"/"+o,l.hours=i,l.minutes=r,l.am_pm=a,l},Utils.prototype.getDateAsString=function(t){var e=["January","February","March","April","May","June","July","August","September","October","November","December"],n=t.getDate(),o=t.getMonth(),i=t.getFullYear();return e[o]+" "+n+", "+i},Utils.prototype.gotoParent=function(t){gotoKnackParent()},Utils.prototype.gotoDirectParent=function(){var t=window.location.href.toString(),e=t.lastIndexOf("/");e=t.lastIndexOf("/",e-2),window.location.href=t.substring(0,e)},Utils.prototype.getDirectParentUrl=function(){var t=window.location.href.toString(),e=t.lastIndexOf("/");return e=t.lastIndexOf("/",e-2),t.substring(0,e)},Utils.prototype.loadScript=function(t){var e=document.createElement("script");e.src=t,document.body.appendChild(e)},Utils.prototype.lazyLoad=function(t,e){t instanceof Array||(t=[t]),LazyLoad.js(t,function(){console.log("done lazy load of: "+t),e&&e()})},Utils.prototype.loadScriptSynchronously=function(t){var e=new XMLHttpRequest;e.open("GET",t,!1),e.send("");var n=document.createElement("script");n.type="text/javascript",n.text=e.responseText,document.getElementsByTagName("head")[0].appendChild(n)},Utils.prototype.loadCss=function(t){$("<link>").appendTo("head").attr({type:"text/css",rel:"stylesheet"}).attr("href",t)},Utils.prototype.showDialog=function(t){this.checkExistDialog(),$("#lightboxContent").html(t),document.getElementById("light").style.display="block",document.getElementById("fade").style.display="block"},Utils.prototype.showNotify=function(t,e){var n=this;n.showDialog(t),e||(e=1e3),setTimeout(function(){n.hideDialog()},e)},Utils.prototype.hideDialog=function(){this.checkExistDialog(),document.getElementById("light").style.display="none",document.getElementById("fade").style.display="none"},Utils.prototype.showModalDialog=function(t){window.model?window.model.setContent(t):window.model=new jBox("Modal",{content:t}),window.model.open()},Utils.prototype.hideModalDialog=function(){window.model&&window.model.close()},window.showModalDialog=function(t){window.modal?window.modal.setContent(t):window.modal=new jBox("Modal",{content:t}),window.modal.open()},window.showAjaxModalDialog=function(t){window.modal?window.modal.ajax(t):window.modal=new jBox("Modal"),window.modal.open()},window.hideModalDialog=function(){window.modal&&window.modal.close()},Utils.prototype.showModalNotify=function(t,e){var n=this;n.showModalDialog(t),e||(e=1e3),setTimeout(function(){n.hideModalDialog()},e)},Utils.prototype.checkExistDialog=function(){var t=this;if(0===$("#light").length){var e="display:none;position:absolute;top:0%;left:0%;width:3500px;height:3500px;background-color:gray;z-index:1001;-moz-opacity:0.8;opacity:.80;filter:alpha(opacity=80);",n="display:none; position:fixed; left:30%; top:30%; padding:16px; border:1pxsolidblack; background-color:white; z-index:1002; overflow:auto;";$(document.body).append($('<div id="light"><div id="lightboxContent"></div></div> <div id="fade"></div>'));var o=$("#fade");o.attr("style",e);var i=$("#light");i.attr("style",n),$(document).click(function(e){t.hideDialog()})}},Utils.prototype.minPause=function(t,e,n){var o=Date.now(),i=o-e;n>i?setTimeout(function(){t()},n-i):t()},Utils.prototype.refreshKnackPage=function(t){0!==$("a.ang-link:contains('"+t+"')").length&&$("a.ang-link:contains('"+t+"')")[0].click()},Utils.prototype.refreshCurrentKnackPage=function(){var t="a.ang-link[href='"+window.location.hash.substring(0,window.location.hash.length-1)+"?']";0!==$(t).length&&$(t)[0].click()},Utils.prototype.ce=function(t){return $("<"+t+"/>")},Utils.prototype.getColumnWithLabel=function(t,e){var n=-1,o=t.columns,i=0;return $.each(o,function(t,o){o.grouping&&(i+=1);var r=o.header;return r&&(r=r.toLocaleLowerCase(),e.toLocaleLowerCase()===r)?(n=t+1-i,!1):void 0}),n},Utils.prototype.getLastIdInUrl=function(){var t=window.location.href.toString(),e=t.lastIndexOf("/"),n=t.lastIndexOf("/",e-1),o=t.substring(n+1,e);return o},Utils.prototype.addDescriptionToMenuButton=function(t,e,n){$("#view_"+t+" ul li.kn-link-"+e+" a").after("<br>"+n)},Utils.prototype.doSafe=function(t,e){try{t()}catch(n){e()}},Utils.prototype.callbackWhenReady=function(){},Utils.prototype.cloneObject=function(t){if(null===t||"object"!=typeof t)return t;var e=t.constructor();for(var n in t)e[n]=this.cloneObject(t[n]);return e},Utils.prototype.cloneKnackRecord=function(t){if(null===t||"object"!=typeof t)return t;var e=t.constructor();for(var n in t)n.indexOf("_raw")>0&&"object"==typeof t[n]&&t[n][0]?e[n.substring(0,n.indexOf("_raw"))]=t[n][0].id:e[n]=this.cloneObject(t[n]);return e},Utils.prototype.getKnackValue=function(t,e){if(!e)throw new Error("no field!");var n=null,o=e;-1===e.indexOf("_raw")&&(o=e+"_raw");var i=t.hasOwnProperty(o)&&"object"==typeof t[o];if(i&&""!==t[e])if(t[o]instanceof Array&&1===t[o].length)n=t[o][0].id;else if(t[o]instanceof Array&&t[o].length>1){n=[];for(var r=0;r<t[o].length;r++){var a=t[o][r];a.id?n.push(a.id):n=n.toString()+","+a}}else n=t[o];else n=t[e];return n},Utils.prototype.getKnackValue2=function(t,e){if(!e)throw new Error("no field!");var n=null,o=e;-1===e.indexOf("_raw")&&(o=e+"_raw");var i=t.hasOwnProperty(o)&&"object"==typeof t[o];if(i){if(t[o]instanceof Array){var r=t[o];r.length>0?n=r[0]:(n=t[e],n.indexOf("span")>0&&(n=$(n).text()))}else if(t[o]instanceof Object){var a=t[o];a.hasOwnProperty("url")&&(n=a.url)}}else n=t[e],"string"==typeof n&&n.indexOf("span")>0&&(n=$(n).text());return n},Utils.prototype.isConnection=function(t,e){var n=e;-1===e.indexOf("_raw")&&(n=e+"_raw");var o=t.hasOwnProperty(n)&&"object"==typeof t[n];return o&&""!==t[e]&&t[n]instanceof Array&&1===t[n].length?!0:!1},Utils.prototype.getCurrentUserId=function(){var t=$("div .kn-current_user");return t.attr("id")},Utils.prototype.getKnackUrl=function(t){return"https://api.knackhq.com/v1/objects/"+t+"/records"},Utils.prototype.getUrlParameter=function(t){var e,n,o=decodeURIComponent(window.location.search.substring(1)),i=o.split("&");for(n=0;n<i.length;n++)if(e=i[n].split("="),e[0]===t)return void 0===e[1]?!0:e[1]},Utils.prototype.getIdFromFormOnPage=function(){var t=$("form div.kn-submit input[name='id']");return t&&t.length>0?t.val():null},Utils.prototype.getIdFromForm=function(t){var e=$("#"+t+" form div.kn-submit input[name='id']");return e&&e.length>0?e.val():null},Utils.prototype.addTotalForPivotTable=function(t,e){$("#"+t+" table thead tr th:last").after("<th>"+(e||"Total")+"</th>"),$("#"+t+" table tbody tr").each(function(t,e){for(var n=0,o=null,t=0;t<e.children.length;t++)o=e.children[t],"kn-pivot-calc"==o.className&&(n+=parseInt(o.innerHTML));$(o).after("<td style='text-align:right;' class='kn-pivot-calc'>"+n+" </td>")})},Utils.prototype.getKnackConnectionId=function(t,e,n){return n="undefined"==typeof n?0:n,t[e]&&t[e][n]?t[e][n].id:null},Utils.prototype.getFieldValueFromDetails=function(t){return $("."+t+" td span").html()},Utils.prototype.getFieldValueIdFromDetails=function(t){return $("."+t+" td span span").attr("class")},Utils.prototype.jboxOKConfirmAlert=function(t,e,n,o,i,r,a){window.utils.clearAnyJboxDialogs(),r||(r="OK"),a||(a=""),o||(o=750),i||(i=150);var l=new jBox("Confirm",{title:t,content:e,width:o,height:i,maxWidth:o,animation:{open:"zoomIn",close:"zoomIn"},overlay:!0,repositionOnContent:!0,onOpen:function(){$("div.jBox-Confirm-button.jBox-Confirm-button-cancel").hide()},onClose:function(){},confirmButton:r,cancelButton:"",confirm:function(){l.close(),n&&n()},closeButton:a});return window.utils.okConfirmAlert=l,l.open(),l},Utils.prototype.jboxOKCancelAlert=function(t,e,n,o,i,r,a,l){window.utils.clearAnyJboxDialogs(),i||(i=750),r||(r=150);var s="OK";a&&(s=a);var c="Cancel";l&&(c=l);var d=new jBox("Confirm",{title:t,content:e,width:i,height:r,maxWidth:i,animation:{open:"zoomIn",close:"zoomIn"},overlay:!0,repositionOnContent:!0,onOpen:function(){},onClose:function(){},confirmButton:s,cancelButton:c,confirm:function(){n&&n()},cancel:function(){o&&o()}});window.utils.okConfirmAlert=d,d.open()},Utils.prototype.clearAnyJboxDialogs=function(){window.utils.modalAlert&&(window.utils.modalAlert.close(),window.utils.modalAlert=null),window.utils.okConfirmAlert&&(window.utils.okConfirmAlert.close(),window.utils.okConfirmAlert=null)},Utils.prototype.closeAnyJboxDialogs=function(){this.clearAnyJboxDialogs()},Utils.prototype.jboxModalAlert=function(t,e,n,o,i,r){r||window.utils.clearAnyJboxDialogs(),o||(o=500),i||(i=150);var a=new jBox("Modal",{title:t,content:e,width:o,height:i,maxWidth:o,animation:{open:"zoomIn",close:"zoomIn"},overlay:!0,repositionOnContent:!0,closeOnClick:!0,onOpen:function(){},onClose:function(){n&&n()}});return window.utils.modalAlert=a,a.open(),a},Utils.prototype.safeGetRawFieldValue=function(t,e,n,o){return e||(e="id"),o||(o=0),t&&e?t instanceof Array&&t.length>o?t[o][e]:t[e]:n},Utils.prototype.getSafeValue=function(t,e){var n=t[e],o=e+"_raw";return this.safeGetRawFieldValue(t[o])?this.safeGetRawFieldValue(t[o]):n},Utils.prototype.toCamel=function(t){return t.replace(/^([A-Z])|\s(\w)/g,function(t,e,n,o){return n?n.toUpperCase():e.toLowerCase()})},Utils.prototype.hasValueInDropdown=function(t,e,n){return $("#view_"+t+"-field_"+e+" option").each(function(){var t=$(this);return t.val()===n?!0:void 0}),!1},Utils.prototype.splitString=function(t,e){var n=new RegExp(".{1,"+e+"}","g");return t.match(n)},Utils.prototype.queryString=function(){for(var t={},e=window.location.search.substring(1),n=e.split("&"),o=0;o<n.length;o++){var i=n[o].split("=");if("undefined"==typeof t[i[0]])t[i[0]]=decodeURIComponent(i[1]);else if("string"==typeof t[i[0]]){var r=[t[i[0]],decodeURIComponent(i[1])];t[i[0]]=r}else t[i[0]].push(decodeURIComponent(i[1]))}return t},Utils.prototype.hideKnackTableColumn=function(t,e){var n=function(t){$(this).css("display","none")};$("#view_"+t+" table td.field_"+e).each(n),$("#view_"+t+" table th.field_"+e).each(n)},Utils.prototype.getDateTimeValue=function(t,e){var n=$("#"+t).val(),o=$("#"+e).val(),i=n.split("/"),r=new Date(i[0],i[1]-1,i[3],0,0,0,0),a=o.match(/(\d+)(?::(\d\d))?\s*(p?)/);return a.length>0&&(r.setHours(parseInt(a[1])+(a[3]?12:0)),r.setMinutes(parseInt(a[2])||0)),r},Utils.prototype.addBottomPagination=function(t){var e=$("#"+t+" .kn-records-nav");if(0==e.length||e.length>1)return 0;var n=e.clone(!0,!0);return n.css("margin-top","8px"),e.next().after(n),n},Utils.prototype.addTopSaveButton=function(t){if($("#"+t+" form .kn-submit").length>1)return 0;var e=$("#"+t+" form .kn-submit");if(0==e.length)return 0;var n=e.clone(!0,!0);n.css("margin-bottom","10px"),$("#"+t+" form").prepend(n)},Utils.prototype.setPaginationControlsVisible=function(t,e){var n=$("#"+t+" .kn-records-nav .kn-pagination");return 0==n.length?0:void n.each(function(t,n){e?$(n).css("display",""):$(n).css("display","none")})},Utils.prototype.setPaginationButtonText=function(t,e,n,o){o||(o="right");var i=$("#"+t+" .kn-records-nav .kn-pagination");return 0==i.length?0:void i.each(function(t,i){$(i).css("float",o);var r=$(i).find("a");r.css("width","60px");var a=$(i).find("a span");a.css("text-indent","0px"),a.css("top","0px"),a.css("left","4px"),a.css("background","none"),a.css("font-size","12px"),r.find("span").text(e),r.next().find("span").text(n)})},Utils.prototype.getFieldIds=function(t){var e=t.find(":input").map(function(){return $(this).closest("div.address-us").length>0?"street":this.id?this.id:void 0}).get();return _.uniq(e)},Utils.prototype.addElementToTable=function(t,e){e||(e='<input type="checkbox">');var n=$("#"+t.key+" .kn-table");return 0===n.length&&(n=$("#"+t.key+" .kn-table-table")),0===n.length?void console.log("Error, cannot find table!"):void(n.find("tbody tr td").length>0&&n.find("tbody tr td")[0].innerHTML===e||(n.find("thead tr").prepend("<th>"+e+"</th>"),n.find("thead input").change(function(){n.find("tbody tr input").each(function(){$(this).attr("checked",void 0!=n.find("thead input").attr("checked"))})}),n.find("tbody tr").each(function(){$(this).prepend("<td>"+e+"</td>")})))},Utils.prototype.hideKnackMenuButton=function(t){$('span:contains("'+t+'")').closest("li").hide()},Utils.prototype.showKnackMenuButton=function(t){$('span:contains("'+t+'")').closest("li").show()},Utils.prototype.createCookie=function(t,e,n){var o;if(n){var i=new Date;i.setTime(i.getTime()+24*n*60*60*1e3),o="; expires="+i.toGMTString()}else o="";document.cookie=t+"="+e+o+"; path=/"},Utils.prototype.getCookie=function(t){if(document.cookie.length>0){var e=document.cookie.indexOf(t+"=");if(-1!=e){e=e+t.length+1;var n=document.cookie.indexOf(";",e);return-1==n&&(n=document.cookie.length),unescape(document.cookie.substring(e,n))}}return""},Utils.prototype.exportCSV=function(t,e,n){var o=t+e,i="data:text/csv;charset=utf-8,"+o,r=encodeURI(i),a=document.createElement("a");a.setAttribute("href",r),a.setAttribute("download",n),a.click()},Utils.prototype.getKnackViewTableCSV=function(t,e,n,o){o||(o=this.csvContentBuilder);for(var i=$("#"+e+" table thead th"),r=[],a="",l=0;l<i.length;l++){var s=$(i[l]),c=s.text();c=c.trim(),console.log("titleText: "+c);var d={title:c,fieldName:s.attr("class")};r.push(d),a+=d.title,l+1<i.length&&(a+=",")}a+="\n",window.dao.getViewRecords(t,e).then(function(t){var e=o(r,t.records);n(a,e)})},Utils.prototype.csvContentBuilder=function(t,e,n){var o="";if(e.length>0)for(var i in e){for(var r="",a=e[i],l=0;l<t.length;l++){var s=t[l],c=window.utils.getKnackValue2(a,s.fieldName);n&&(c=n(l,c)),c=(""+c).replace(/"/g,'""'),c='"'+c+'"',r+=c,l+1<t.length&&(r+=",")}o+=r+"\n"}return o},Utils.prototype.resetCombobox=function(t){$(t).val("Select"),$(t).trigger("change"),$(t).trigger("liszt:updated"),$(t).trigger("chosen:updated")},window.utils=new Utils,window.utils.init(),window.awzUtil=new Utils,window.awzUtil.init();
